# Have been vibecoded and fixed by Lokilife
name: Sync Merged Upstream PRs

on:
  # schedule:
  #   - cron: '*/15 * * * *'
  workflow_dispatch:

jobs:
  sync-merged-prs:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/create-github-app-token@v2
        id: app-token
        name: Get Github Token
        with:
          app-id: ${{ vars.SERVANT_APP_ID }}
          private-key: ${{ secrets.SERVANT_PRIVATE_KEY }}

      - name: Checkout main branch
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ steps.app-token.outputs.token }}
          ref: main

      - name: Setup Git
        run: |
          git config --global user.name "Lokilife's Servant[bot]"
          git config --global user.email "2643756+lokilife-servant[bot]@users.noreply.github.com"
          git remote add upstream https://github.com/Monolith-Station/Monolith.git
          git config --global pull.rebase false

      - name: Fetch all branches
        run: |
          git fetch upstream
          git fetch origin

      - name: Get sync state from upstream-sync branch
        id: load-sync-state
        run: |
          git fetch origin upstream-sync || echo "Branch upstream-sync doesn't exist yet"

          if git show-ref --verify refs/remotes/origin/upstream-sync && git cat-file -e origin/upstream-sync:.synced-prs.json 2>/dev/null; then
            echo "Loading .synced-prs.json from upstream-sync branch"
            git cat-file blob origin/upstream-sync:.synced-prs.json > .synced-prs.json
          else
            echo "No sync state found, creating empty state"
            echo '{}' > .synced-prs.json
          fi

          echo "Current sync state has $(jq 'length' .synced-prs.json || echo 0) entries"

      - name: Get merged PRs from upstream (last 24 hours)
        id: get-merged-prs
        run: |
          since_date=$(date -d '24 hours ago' +%Y-%m-%dT%H:%M:%SZ)

          response=$(curl -s \
            -H "Authorization: token ${{ steps.app-token.outputs.token }}" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/Monolith-Station/Monolith/pulls?state=closed&sort=updated&direction=desc&per_page=50")

          merged_prs=$(echo "$response" | jq -c '
            [.[] | 
             select(.merged_at != null and .merged_at > "'"$since_date"'") |
             {
               number: .number,
               title: .title,
               merge_commit_sha: .merge_commit_sha,
               merged_at: .merged_at
             }
            ]')

          echo "Found $(echo $merged_prs | jq length) merged PRs"

          delimiter="$(openssl rand -hex 8)"
          echo "merged_prs<<${delimiter}" >> $GITHUB_OUTPUT
          echo "$merged_prs" >> $GITHUB_OUTPUT
          echo "${delimiter}" >> $GITHUB_OUTPUT

      - name: Process merged PRs
        env:
          MERGED_PRS: ${{ steps.get-merged-prs.outputs.merged_prs }}
          GITHUB_TOKEN: ${{ steps.app-token.outputs.token }}
          REPO: ${{ github.repository }}
        run: |
          synced_prs=$(cat .synced-prs.json)
          updated_synced_prs="$synced_prs"
          processed_count=0
          any_changes=false

          echo "Processing PRs..."

          save_sync_state() {
            echo "Saving sync state via API..."
            CURRENT_STATE=$(cat .synced-prs.json)

            CONTENT_BASE64=$(echo "$CURRENT_STATE" | base64 | tr -d '\n')
            
            if git ls-remote --exit-code origin upstream-sync >/dev/null 2>&1 && \
               git cat-file -e origin/upstream-sync:.synced-prs.json 2>/dev/null; then
              EXISTING_SHA=$(git cat-file blob origin/upstream-sync:.synced-prs.json | git hash-object --stdin)
              CURRENT_SHA=$(echo "$CURRENT_STATE" | git hash-object --stdin)
              
              if [ "$EXISTING_SHA" = "$CURRENT_SHA" ]; then
                echo "No changes to sync state"
                return
              fi

              FILE_SHA=$(git ls-tree origin/upstream-sync .synced-prs.json 2>/dev/null | awk '{print $3}' || echo "")

              curl -X PUT \
                -H "Authorization: token $GITHUB_TOKEN" \
                -H "Accept: application/vnd.github.v3+json" \
                -d "{
                  \"message\": \"Update sync tracking $(date +%Y-%m-%d_%H:%M:%S)\",
                  \"content\": \"$CONTENT_BASE64\",
                  \"branch\": \"upstream-sync\",
                  \"sha\": \"$FILE_SHA\"
                }" \
                "https://api.github.com/repos/$REPO/contents/.synced-prs.json" 2>/dev/null || \

              curl -X PUT \
                -H "Authorization: token $GITHUB_TOKEN" \
                -H "Accept: application/vnd.github.v3+json" \
                -d "{
                  \"message\": \"Update sync tracking $(date +%Y-%m-%d_%H:%M:%S)\",
                  \"content\": \"$CONTENT_BASE64\",
                  \"branch\": \"upstream-sync\"
                }" \
                "https://api.github.com/repos/$REPO/contents/.synced-prs.json"
            else
              curl -X PUT \
                -H "Authorization: token $GITHUB_TOKEN" \
                -H "Accept: application/vnd.github.v3+json" \
                -d "{
                  \"message\": \"Initialize sync tracking branch\",
                  \"content\": \"$CONTENT_BASE64\",
                  \"branch\": \"upstream-sync\"
                }" \
                "https://api.github.com/repos/$REPO/contents/.synced-prs.json"
            fi

            echo "Sync state saved via API"
          }

          echo "$MERGED_PRS" | jq -c '.[]' | while read pr; do
            PR_NUMBER=$(echo $pr | jq -r '.number')
            PR_TITLE=$(echo $pr | jq -r '.title')
            MERGE_SHA=$(echo $pr | jq -r '.merge_commit_sha')

            if echo "$synced_prs" | jq -e ".[\"$PR_NUMBER\"]" > /dev/null 2>&1; then
              echo "PR #$PR_NUMBER already processed, skipping"
              continue
            fi

            if git log main --oneline | grep -q "$MERGE_SHA"; then
              echo "Merge commit $MERGE_SHA already exists in main"
              updated_synced_prs=$(echo "$updated_synced_prs" | jq --arg num "$PR_NUMBER" --arg sha "$MERGE_SHA" '.[$num]={sha: $sha, processed_at: "'$(date -Iseconds)'", status: "already_exists"}')
              echo "$updated_synced_prs" > .synced-prs.json
              any_changes=true
              continue
            fi

            if git branch -r --contains "$MERGE_SHA" 2>/dev/null | grep -q "origin/"; then
              echo "Merge commit $MERGE_SHA already exists in repo but not in main"
              updated_synced_prs=$(echo "$updated_synced_prs" | jq --arg num "$PR_NUMBER" --arg sha "$MERGE_SHA" '.[$num]={sha: $sha, processed_at: "'$(date -Iseconds)'", status: "already_exists"}')
              echo "$updated_synced_prs" > .synced-prs.json
              any_changes=true
              continue
            fi

            echo "Processing PR #$PR_NUMBER: $PR_TITLE"

            TIMESTAMP=$(date +%s)
            BRANCH_NAME="sync/pr-$PR_NUMBER-$TIMESTAMP"

            git checkout -b "$BRANCH_NAME" main

            if git cherry-pick "$MERGE_SHA" --no-commit 2>/dev/null; then
              if [ -n "$(git status --porcelain)" ]; then
                git commit -m "Sync upstream PR $PR_NUMBER: $PR_TITLE" --allow-empty
                git push origin "$BRANCH_NAME"

                gh pr create \
                  --repo "$REPO" \
                  --title "[Sync] Upstream PR $PR_NUMBER: $PR_TITLE" \
                  --body $'**Upstream PR:** $PR_NUMBER - $PR_TITLE\n\nThis PR was automatically created to sync changes from the upstream repository.' \
                  --base main \
                  --head "$BRANCH_NAME"

                status="synced"
              else
                echo "No changes after cherry-pick, skipping PR creation"
                status="no_changes"
                git checkout main
                git branch -D "$BRANCH_NAME"
              fi

            else
              echo "Conflicts detected in PR #$PR_NUMBER"

              git add -A || true
              git commit -m "Sync upstream PR $PR_NUMBER with conflicts" --allow-empty
              git push origin "$BRANCH_NAME"

              gh pr create \
                --repo "$REPO" \
                --title "[CONFLICT] Upstream PR $PR_NUMBER: $PR_TITLE" \
                --body "⚠️ **CONFLICTS DETECTED** ⚠️\n\n"\
                "**Upstream PR:** $PR_NUMBER - $PR_TITLE\nThis PR has merge conflicts that need manual resolution.\n\n" \
                "This PR was automatically created to sync changes from the upstream repository.\n" \
                "Please resolve conflicts before merging." \
                --base main \
                --head "$BRANCH_NAME"

              git cherry-pick --abort 2>/dev/null || true
              status="conflict"
            fi

            git checkout main

            updated_synced_prs=$(echo "$updated_synced_prs" | jq --arg num "$PR_NUMBER" --arg sha "$MERGE_SHA" --arg status "$status" '.[$num]={sha: $sha, processed_at: "'$(date -Iseconds)'", status: $status, branch: "'$BRANCH_NAME'"}')
            echo "$updated_synced_prs" > .synced-prs.json
            any_changes=true

            processed_count=$((processed_count + 1))

            if [ $processed_count -ge 3 ]; then
              echo "Saving intermediate sync state after $processed_count PRs"
              save_sync_state
              processed_count=0
            fi

          done

          if [ "$any_changes" = true ]; then
            echo "Saving final sync state"
            save_sync_state
          else
            echo "No changes to sync state"
          fi

      # - name: Cleanup old branches
      #   if: always()
      #   run: |
      #     # Удаляем локальные ветки sync/ старше 2 дней
      #     git fetch --prune
      #     git branch | grep '^sync/' | while read branch; do
      #       branch_age=$(git log -1 --format='%ct' "$branch" 2>/dev/null || echo 0)
      #       current_time=$(date +%s)
      #       if [ $((current_time - branch_age)) -gt $((2 * 24 * 3600)) ]; then
      #         echo "Deleting old local branch: $branch"
      #         git branch -D "$branch" || true
      #       fi
      #     done
